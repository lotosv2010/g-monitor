{"version":3,"file":"monitor.umd.js","sources":["../../../sdk/src/perf.js","../../../sdk/src/util.js","../../../sdk/src/resources.js","../../../sdk/src/index.js"],"sourcesContent":["// https://developer.mozilla.org/zh-CN/docs/Web/API/PerformanceTiming\n\nlet perf = {\n  init: (cb) => {\n    let cycleFreq = 100; // 循环轮询的时间\n    let isDOMReady = false;\n    let isOnload = false;\n    let performance = window.performance || window.mozPerformance || window.msPerformance || window.webkitPerformance;\n\n    let Util = {\n      addEventListener: function (name, callback, useCapture) {\n        if (window.addEventListener) {\n          return window.addEventListener(name, callback, useCapture);\n        } else if (window.attachEvent) {\n          return window.attachEvent('on' + name, callback);\n        }\n      },\n      // DOM解析完成\n      domready: function (callback) {\n        if ( isDOMReady === true ) { return void 0; }\n        let timer = null;\n\n        if ( document.readyState === 'interactive' ) {\n          runCheck();\n        } else if (document.addEventListener) {\n          // 开始循环检测是否 DOMContentLoaded\n          document.addEventListener('DOMContentLoaded', function () {\n            runCheck();\n          }, false);\n        } else if (document.attachEvent) {\n          document.attachEvent('onreadystatechange', function () {\n            runCheck();\n          });\n        }\n\n        function runCheck() {\n          if ( performance.timing.domInteractive ) { // 停止循环检测，运行callback\n            clearTimeout(timer);\n            callback();\n            isDOMReady = true;\n          } else { // 再次循环检测\n            timer = setTimeout(runCheck, cycleFreq);\n          }\n        }\n      },\n      // 页面加载完成\n      onload: function (callback) {\n        if ( isOnload === true ) { return void 0; }\n        let timer = null;\n\n        if (document.readyState === 'complete') {\n          runCheck();\n        } else {\n          Util.addEventListener('load', function () {\n            runCheck();\n          }, false);\n        }\n\n        function runCheck() {\n          if ( performance.timing.loadEventEnd ) {\n            clearTimeout(timer);\n            callback();\n            isOnload = true;\n          } else {\n            timer = setTimeout(runCheck, cycleFreq);\n          }\n        }\n      }\n    };\n\n    let reportPerf = function () {\n      if (!performance) {\n        return void 0;\n      }\n\n      // 过滤无效数据；\n      function filterTime(a, b) {\n        return (a > 0 && b > 0 && (a - b) >= 0) ? (a - b) : undefined;\n      }\n\n      // append data from window.performance\n      let timing = performance.timing;\n      // let timing = performance.getEntriesByType('navigation')[0];\n\n      let perfData = {\n        // 网络建连\n        pervPage: filterTime(timing.fetchStart, timing.navigationStart), // 上一个页面\n        redirect: filterTime(timing.responseEnd, timing.redirectStart), // 页面重定向时间\n        dns: filterTime(timing.domainLookupEnd, timing.domainLookupStart), // DNS查找时间\n        connect: filterTime(timing.connectEnd, timing.connectStart), // TCP建连时间\n        network: filterTime(timing.connectEnd, timing.navigationStart), // 网络总耗时\n\n        // 网络接收\n        send: filterTime(timing.responseStart, timing.requestStart), // 前端从发送到接收到后端第一个返回\n        receive: filterTime(timing.responseEnd, timing.responseStart), // 接受页面时间\n        request: filterTime(timing.responseEnd, timing.requestStart), // 请求页面总时间\n\n        // 前端渲染\n        dom: filterTime(timing.domComplete, timing.domLoading), // dom解析时间\n        loadEvent: filterTime(timing.loadEventEnd, timing.loadEventStart), // loadEvent时间\n        frontend: filterTime(timing.loadEventEnd, timing.domLoading), // 前端总时间\n\n        // 关键阶段\n        load: filterTime(timing.loadEventEnd, timing.navigationStart), // 页面完全加载总时间\n        domReady: filterTime(timing.domContentLoadedEventStart, timing.navigationStart), // domready时间\n        interactive: filterTime(timing.domInteractive, timing.navigationStart), // 可操作时间\n        ttfb: filterTime(timing.responseStart, timing.navigationStart),  // 首字节时间\n      };\n\n      return perfData;\n    };\n\n    Util.domready(function () {\n      let perfData = reportPerf('domready');\n      perfData.type = 'domready';\n      cb(perfData);\n    });\n\n    Util.onload(function () {\n      let perfData = reportPerf('onload');\n      perfData.type = 'onload';\n      cb(perfData);\n    });\n  }\n};\n\nexport default perf;\n","export let noop = () => {};\nexport let onload = (cb) => {\n  if (document.readyState === 'complete') {\n    cb();\n    return;\n  }\n  window.addEventListener('load', cb);\n};\n\nexport default {\n  noop,\n  onload\n};\n","import {onload} from './util.js';\n\n// 过滤无效数据\nfunction filterTime(a, b) {\n  return (a > 0 && b > 0 && (a - b) >= 0) ? (a - b) : undefined;\n}\n\nlet resolvePerformanceTiming = (timing) => {\n  let o = {\n    initiatorType: timing.initiatorType,\n    name: timing.name,\n    // 连接过程\n    duration: parseInt(timing.duration),\n    redirect: filterTime(timing.redirectEnd, timing.redirectStart), // 重定向\n    dns: filterTime(timing.domainLookupEnd, timing.domainLookupStart), // DNS解析\n    connect: filterTime(timing.connectEnd, timing.connectStart), // TCP建连\n    network: filterTime(timing.connectEnd, timing.startTime), // 网络总耗时\n    // 接受过程\n    send: filterTime(timing.responseStart, timing.requestStart), // 发送开始到接受第一个返回\n    receive: filterTime(timing.responseEnd, timing.responseStart), // 接收总时间\n    request: filterTime(timing.responseEnd, timing.requestStart), // 总时间\n\n    // 核心指标\n    ttfb: filterTime(timing.responseStart, timing.requestStart), // 首字节时间\n  };\n\n  return o;\n};\n\nlet resolveEntries = (entries) => entries.map(item => resolvePerformanceTiming(item));\n\nlet resources = {\n  init: (cb) => {\n    let performance = window.performance || window.mozPerformance || window.msPerformance || window.webkitPerformance;\n    if (!performance || !performance.getEntries) {\n      return void 0;\n    }\n\n    if (window.PerformanceObserver) {\n      // 动态获得每一个资源信息\n      let observer = new window.PerformanceObserver((list) => {\n        try {\n          let entries = list.getEntries();\n          cb(resolveEntries(entries));\n        } catch (e) {\n          console.error(e);\n        }\n      });\n      observer.observe({\n        entryTypes: ['resource']\n      })\n    } else {\n      // 在onload之后获取所有的资源新\n      onload(() => {\n        let entries = performance.getEntriesByType('resource');\n        cb(resolveEntries(entries));\n      });\n    }\n  },\n};\n\nexport default resources;\n","import perf from './perf';\nimport resources from './resources'\n\n// 性能监控\nperf.init((perfData) => {\n  console.log('perfData', perfData)\n});\n\n// 资源监控\nresources.init((resourcesData) => {\n  console.log('resourcesData', resourcesData)\n});\n"],"names":[],"mappings":"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"}